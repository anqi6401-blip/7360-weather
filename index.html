<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯å°é£æ•°æ®æŸ¥è¯¢ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .tab-content {
            padding: 20px 0;
        }
        .shelter-item {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4" style="background: #f8f9fa; min-height: 100vh;">
        <div class="container">
            <!-- æ ‡é¢˜ -->
            <div class="text-center mb-4">
                <h1 class="display-4">ğŸŒªï¸ é¦™æ¸¯å°é£æ•°æ®æŸ¥è¯¢ç³»ç»Ÿ</h1>
                <p class="lead">å®æ—¶æŸ¥è¯¢å°é£æ•°æ®å’Œåº‡æŠ¤æ‰€ä¿¡æ¯</p>
            </div>

            <!-- æœåŠ¡å™¨çŠ¶æ€ -->
            <div class="section">
                <h4>ğŸ”— æœåŠ¡å™¨è¿æ¥</h4>
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" id="serverUrl" class="form-control" 
                               value="http://localhost:8080" placeholder="è¾“å…¥ColabæœåŠ¡å™¨åœ°å€">
                    </div>
                    <div class="col-md-6">
                        <button onclick="testConnection()" class="btn btn-primary">æµ‹è¯•è¿æ¥</button>
                        <span id="connectionStatus" class="ms-2"></span>
                    </div>
                </div>
            </div>

            <!-- åº‡æŠ¤æ‰€æŸ¥è¯¢ -->
            <div class="section">
                <h4>ğŸ  åº‡æŠ¤æ‰€æŸ¥è¯¢</h4>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <button onclick="getTotalShelters()" class="btn btn-outline-primary w-100">
                            è·å–åº‡æŠ¤æ‰€æ€»æ•°
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button onclick="getDistrictCounts()" class="btn btn-outline-primary w-100">
                            å„åœ°åŒºæ•°é‡ç»Ÿè®¡
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button onclick="getAllShelters()" class="btn btn-outline-primary w-100">
                            æ˜¾ç¤ºæ‰€æœ‰åº‡æŠ¤æ‰€
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <select id="districtSelect" class="form-select">
                            <option value="">é€‰æ‹©åœ°åŒº...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <button onclick="getSheltersByDistrict()" class="btn btn-primary w-100">
                            æŒ‰åœ°åŒºæŸ¥è¯¢
                        </button>
                    </div>
                </div>
                
                <div id="sheltersResults" class="mt-3"></div>
            </div>

            <!-- å°é£æ•°æ® -->
            <div class="section">
                <h4>ğŸŒ€ å°é£æ•°æ®æŸ¥è¯¢</h4>
                
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="row" id="typhoonStats">
                    <!-- ç»Ÿè®¡ä¿¡æ¯ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                </div>

                <!-- å¹´ä»½æ ‡ç­¾ -->
                <ul class="nav nav-tabs" id="yearTabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showAllTyphoons()">å…¨éƒ¨å¹´ä»½</a>
                    </li>
                    <!-- å¹´ä»½æ ‡ç­¾ä¼šåŠ¨æ€åŠ è½½ -->
                </ul>

                <div class="tab-content">
                    <div id="typhoonResults"></div>
                </div>
            </div>

            <!-- æ”¶è—åŠŸèƒ½ -->
            <div class="section">
                <h4>â­ æ”¶è—åŠŸèƒ½æ¼”ç¤º</h4>
                <div class="row">
                    <div class="col-md-4">
                        <input type="number" id="userId" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·ID" value="123">
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="userName" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·å" value="æµ‹è¯•ç”¨æˆ·">
                    </div>
                    <div class="col-md-4">
                        <button onclick="toggleFavorite()" class="btn btn-warning w-100" id="favoriteBtn">
                            æ”¶è—/å–æ¶ˆæ”¶è—
                        </button>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
            <div id="loading" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p>æŸ¥è¯¢ä¸­...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // é…ç½®
        let BASE_URL = 'http://localhost:8080';

        // DOMå…ƒç´ 
        const loadingElement = document.getElementById('loading');
        const connectionStatus = document.getElementById('connectionStatus');
        const serverUrlInput = document.getElementById('serverUrl');
        const districtSelect = document.getElementById('districtSelect');
        const yearTabs = document.getElementById('yearTabs');
        const typhoonStats = document.getElementById('typhoonStats');
        const sheltersResults = document.getElementById('sheltersResults');
        const typhoonResults = document.getElementById('typhoonResults');
        const favoriteBtn = document.getElementById('favoriteBtn');

        // å·¥å…·å‡½æ•°
        function showLoading(show) {
            loadingElement.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            return `<div class="alert alert-danger">${message}</div>`;
        }

        function showSuccess(message) {
            return `<div class="alert alert-success">${message}</div>`;
        }

        // æœåŠ¡å™¨è¿æ¥
        function updateBaseUrl() {
            BASE_URL = serverUrlInput.value;
        }

        serverUrlInput.addEventListener('change', updateBaseUrl);

        async function testConnection() {
            showLoading(true);
            try {
                const response = await fetch(`${BASE_URL}/api/shelters/total`);
                if (response.ok) {
                    connectionStatus.innerHTML = '<span class="text-success">âœ… è¿æ¥æˆåŠŸ</span>';
                } else {
                    throw new Error('è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                connectionStatus.innerHTML = '<span class="text-danger">âŒ è¿æ¥å¤±è´¥</span>';
            } finally {
                showLoading(false);
            }
        }

        // åº‡æŠ¤æ‰€ç›¸å…³å‡½æ•°
        async function getTotalShelters() {
            showLoading(true);
            try {
                const response = await fetch(`${BASE_URL}/api/shelters/total`);
                const data = await response.json();
                sheltersResults.innerHTML = showSuccess(`é¦™æ¸¯æ€»å…±æœ‰ ${data.total} ä¸ªåº‡æŠ¤æ‰€`);
            } catch (error) {
                sheltersResults.innerHTML = showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function getDistrictCounts() {
            showLoading(true);
            try {
                const response = await fetch(`${BASE_URL}/api/shelters/district-counts`);
                const data = await response.json();
                
                let html = '<h5>å„åœ°åŒºåº‡æŠ¤æ‰€æ•°é‡:</h5><div class="row">';
                data.counts.forEach(item => {
                    html += `<div class="col-md-3 mb-2"><div class="p-2 border rounded">${item.district}: ${item.count}ä¸ª</div></div>`;
                });
                html += '</div>';
                sheltersResults.innerHTML = html;
            } catch (error) {
                sheltersResults.innerHTML = showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function getAllShelters() {
            showLoading(true);
            try {
                const response = await fetch(`${BASE_URL}/api/shelters/all`);
                const data = await response.json();
                
                let html = '<h5>æ‰€æœ‰åº‡æŠ¤æ‰€:</h5>';
                data.shelters.forEach(shelter => {
                    html += `
                        <div class="shelter-item">
                            <strong>${shelter.centreName}</strong><br>
                            <small>åœ°åŒº: ${shelter.district} | åœ°å€: ${shelter.address} | ç”µè¯: ${shelter.tel}</small>
                        </div>
                    `;
                });
                sheltersResults.innerHTML = html;
            } catch (error) {
                sheltersResults.innerHTML = showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function loadDistricts() {
            try {
                const response = await fetch(`${BASE_URL}/api/shelters/districts`);
                const data = await response.json();
                
                districtSelect.innerHTML = '<option value="">é€‰æ‹©åœ°åŒº...</option>';
                data.districts.forEach(district => {
                    districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
                });
            } catch (error) {
                console.error('åŠ è½½åœ°åŒºåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function getSheltersByDistrict() {
            const district = districtSelect.value;
            if (!district) {
                alert('è¯·é€‰æ‹©åœ°åŒº');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`${BASE_URL}/api/shelters/by-district?district=${encodeURIComponent(district)}`);
                const data = await response.json();
                
                let html = `<h5>${district}åœ°åŒºçš„åº‡æŠ¤æ‰€:</h5>`;
                if (data.shelters.length === 0) {
                    html += '<p>è¯¥åœ°åŒºæ²¡æœ‰æ‰¾åˆ°åº‡æŠ¤æ‰€</p>';
                } else {
                    data.shelters.forEach(shelter => {
                        html += `
                            <div class="shelter-item">
                                <strong>${shelter.centreName}</strong><br>
                                <small>åœ°å€: ${shelter.address} | ç”µè¯: ${shelter.tel}</small>
                            </div>
                        `;
                    });
                }
                sheltersResults.innerHTML = html;
            } catch (error) {
                sheltersResults.innerHTML = showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // å°é£æ•°æ®ç›¸å…³å‡½æ•°
        async function loadTyphoonData() {
            await loadOverallStats();
            await loadAvailableYears();
            await showAllTyphoons();
        }

        async function loadOverallStats() {
            try {
                const response = await fetch(`${BASE_URL}/api/typhoon/overall-stats`);
                const data = await response.json();
                
                typhoonStats.innerHTML = `
                    <div class="col-md-6">
                        <div class="stats-card">
                            <h5>æœ€å¸¸è§é£å‘</h5>
                            <h3>${data.most_frequent_direction || 'N/A'}</h3>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <h5>å¹³å‡é£é€Ÿ</h5>
                            <h3>${data.overall_avg_speed} km/h</h3>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        async function loadAvailableYears() {
            try {
                const response = await fetch(`${BASE_URL}/api/typhoon/available-years`);
                const data = await response.json();
                
                data.years.forEach(year => {
                    const li = document.createElement('li');
                    li.className = 'nav-item';
                    li.innerHTML = `<a class="nav-link" href="#" onclick="showTyphoonsByYear(${year})">${year}</a>`;
                    yearTabs.appendChild(li);
                });
            } catch (error) {
                console.error('åŠ è½½å¹´ä»½åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function showAllTyphoons() {
            showLoading(true);
            try {
                const response = await fetch(`${BASE_URL}/api/typhoon/all-data`);
                const data = await response.json();
                displayTyphoonData(data.typhoons, 'æ‰€æœ‰å°é£æ•°æ®');
            } catch (error) {
                typhoonResults.innerHTML = showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function showTyphoonsByYear(year) {
            showLoading(true);
            try {
                const response = await fetch(`${BASE_URL}/api/typhoon/by-year?year=${year}`);
                const data = await response.json();
                displayTyphoonData(data.typhoons, `${year}å¹´å°é£æ•°æ®`);
            } catch (error) {
                typhoonResults.innerHTML = showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayTyphoonData(typhoons, title) {
            let html = `<h5>${title} (å…±${typhoons.length}æ¡è®°å½•)</h5>`;
            
            if (typhoons.length === 0) {
                html += '<p>æ²¡æœ‰æ‰¾åˆ°å°é£æ•°æ®</p>';
            } else {
                html += `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>å¹´ä»½</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>å°é£åç§°</th>
                                    <th>æ–¹å‘</th>
                                    <th>é£é€Ÿ (km/h)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                typhoons.forEach(typhoon => {
                    html += `
                        <tr>
                            <td>${typhoon.tyYear}</td>
                            <td>${typhoon.tyDate}</td>
                            <td>${typhoon.tyName}</td>
                            <td>${typhoon.tyDirect}</td>
                            <td>${typhoon.tySpeed}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
            }
            
            typhoonResults.innerHTML = html;
        }

        // æ”¶è—åŠŸèƒ½
        async function checkFavoriteStatus() {
            const userId = document.getElementById('userId').value;
            if (!userId) return;

            try {
                const response = await fetch(`${BASE_URL}/api/favorite/status?user_id=${userId}`);
                const data = await response.json();
                
                if (data.is_favorite) {
                    favoriteBtn.textContent = 'å–æ¶ˆæ”¶è—';
                    favoriteBtn.classList.remove('btn-warning');
                    favoriteBtn.classList.add('btn-secondary');
                } else {
                    favoriteBtn.textContent = 'æ”¶è—';
                    favoriteBtn.classList.remove('btn-secondary');
                    favoriteBtn.classList.add('btn-warning');
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€å¤±è´¥:', error);
            }
        }

        async function toggleFavorite() {
            const userId = document.getElementById('userId').value;
            const userName = document.getElementById('userName').value;

            if (!userId) {
                alert('è¯·è¾“å…¥ç”¨æˆ·ID');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`${BASE_URL}/api/favorite/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        user_name: userName
                    })
                });

                const data = await response.json();
                
                if (data.success !== undefined) {
                    await checkFavoriteStatus(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    alert(data.success ? 'æ”¶è—æˆåŠŸ!' : 'å·²å–æ¶ˆæ”¶è—');
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // åˆå§‹åŒ–
        document.getElementById('userId').addEventListener('change', checkFavoriteStatus);
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            loadDistricts();
            loadTyphoonData();
            checkFavoriteStatus();
        });
    </script>
</body>
</html>